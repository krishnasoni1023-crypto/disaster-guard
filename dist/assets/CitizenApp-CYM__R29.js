import{c as F,u as U,r as c,j as e,d as A,s as m}from"./index-DeG7gfPn.js";import{A as z}from"./alert-triangle-sA03gO4B.js";import{M as w}from"./map-pin-ocWYqDe0.js";import{X as N}from"./x-BsEcLwr7.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=F("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),q=()=>{const{user:u}=U(),[s,n]=c.useState({incident_type:"",severity:"medium",description:"",hashtags:"",location:null}),[g,h]=c.useState([]),[x,y]=c.useState(!1),[b,d]=c.useState(null),[P,p]=c.useState(!1),[f,v]=c.useState(null);c.useEffect(()=>{(async()=>{try{const{data:t,error:a}=await m.storage.getBucket("citizen-app-media");if(a&&!t){const{error:i}=await m.storage.createBucket("citizen-app-media",{public:!1,allowedMimeTypes:["image/jpeg","image/png","image/gif","video/mp4"],fileSizeLimit:52428800});if(i)throw i}}catch(t){console.error("Error checking/creating bucket:",t),d("Failed to initialize media storage. Please try again.")}})()},[]);const E=async()=>{v(null);try{const r=await new Promise((l,o)=>{navigator.geolocation.getCurrentPosition(l,o,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}),{latitude:t,longitude:a}=r.coords,i=await L(t,a);n(l=>({...l,location:{latitude:t,longitude:a,address:i}}))}catch(r){console.error("Location error:",r);let t="Failed to access location. Please try again.";r.code===1?t="Location access denied. Please enable location services.":r.code===2?t="Location unavailable. Please try again.":r.code===3&&(t="Location request timed out. Please try again."),v(t)}},L=async(r,t)=>{try{return(await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${r}&lon=${t}`)).json()).display_name||"Unknown location"}catch(a){return console.error("Error getting location name:",a),"Unknown location"}},M=r=>{const t=r.target.files;if(!t)return;const a=[],i=50*1024*1024,l=["image/jpeg","image/png","image/gif","video/mp4"];Array.from(t).forEach(o=>{if(!l.includes(o.type)){d(`File type ${o.type} is not supported. Please use JPG, PNG, GIF, or MP4.`);return}if(o.size>i){d(`File ${o.name} is too large. Maximum size is 50MB.`);return}a.push({file:o,preview:URL.createObjectURL(o)})}),h(o=>[...o,...a]),r.target.value=""},S=r=>{h(t=>{const a=[...t];return URL.revokeObjectURL(a[r].preview),a.splice(r,1),a})},_=async r=>{if(r.preventDefault(),!!u){d(null),p(!1),y(!0);try{if(!s.incident_type||!s.severity||!s.description)throw new Error("Please fill in all required fields.");if(!s.location)throw new Error("Please add your location.");const t=await Promise.all(g.map(async i=>{const l=i.file.name.split(".").pop(),o=`${Math.random()}.${l}`,j=`${u.id}/${o}`,{error:k,data:$}=await m.storage.from("citizen-app-media").upload(j,i.file);if(k)throw k;const{data:{publicUrl:C}}=m.storage.from("citizen-app-media").getPublicUrl(j);return C})),{error:a}=await m.from("citizen_reports").insert({user_id:u.id,incident_type:s.incident_type,severity:s.severity,description:s.description,hashtags:s.hashtags.split(",").map(i=>i.trim()),location:s.location,media_urls:t,created_at:new Date().toISOString()});if(a)throw a;n({incident_type:"",severity:"medium",description:"",hashtags:"",location:null}),g.forEach(i=>URL.revokeObjectURL(i.preview)),h([]),p(!0),setTimeout(()=>p(!1),5e3)}catch(t){console.error("Error submitting report:",t),d(t.message||"Failed to submit report. Please try again.")}finally{y(!1)}}};return e.jsxs("div",{className:"max-w-4xl mx-auto p-4 sm:p-6 lg:p-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Citizen App"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600 dark:text-gray-400",children:"Report incidents and help keep your community safe."})]}),b&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(z,{className:"h-5 w-5 text-red-500 dark:text-red-400 mr-2"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400",children:b})]})}),P&&e.jsx("div",{className:"mb-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg",children:e.jsx("p",{className:"text-sm text-green-700 dark:text-green-400",children:"Report submitted successfully! Thank you for helping keep the community safe."})}),e.jsxs("form",{onSubmit:_,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"incident_type",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Incident Type *"}),e.jsxs("select",{id:"incident_type",value:s.incident_type,onChange:r=>n(t=>({...t,incident_type:r.target.value})),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm",required:!0,children:[e.jsx("option",{value:"",children:"Select incident type"}),e.jsx("option",{value:"accident",children:"Accident"}),e.jsx("option",{value:"fire",children:"Fire"}),e.jsx("option",{value:"medical",children:"Medical Emergency"}),e.jsx("option",{value:"crime",children:"Crime"}),e.jsx("option",{value:"natural_disaster",children:"Natural Disaster"}),e.jsx("option",{value:"infrastructure",children:"Infrastructure Issue"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"severity",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Severity Level *"}),e.jsxs("select",{id:"severity",value:s.severity,onChange:r=>n(t=>({...t,severity:r.target.value})),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm",required:!0,children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"critical",children:"Critical"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description *"}),e.jsx("textarea",{id:"description",value:s.description,onChange:r=>n(t=>({...t,description:r.target.value})),rows:4,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm",placeholder:"Describe the incident in detail...",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"hashtags",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Hashtags"}),e.jsx("input",{type:"text",id:"hashtags",value:s.hashtags,onChange:r=>n(t=>({...t,hashtags:r.target.value})),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm",placeholder:"Add comma-separated hashtags, e.g., #emergency, #help"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Location *"}),e.jsxs("div",{className:"mt-1",children:[s.location?e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-md",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(w,{className:"h-5 w-5 text-gray-400 dark:text-gray-500 mr-2"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:s.location.address})]}),e.jsx("button",{type:"button",onClick:()=>n(r=>({...r,location:null})),className:"text-gray-400 hover:text-gray-500 dark:hover:text-gray-300",children:e.jsx(N,{className:"h-5 w-5"})})]}):e.jsxs("button",{type:"button",onClick:E,className:"inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(w,{className:"h-5 w-5 mr-2"}),"Add Location"]}),f&&e.jsx("p",{className:"mt-2 text-sm text-red-600 dark:text-red-400",children:f})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Media"}),e.jsxs("div",{className:"mt-1",children:[e.jsx("div",{className:"flex flex-wrap gap-4 mb-4",children:g.map((r,t)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:r.preview,alt:`Preview ${t+1}`,className:"h-24 w-24 object-cover rounded-lg"}),e.jsx("button",{type:"button",onClick:()=>S(t),className:"absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600",children:e.jsx(N,{className:"h-4 w-4"})})]},t))}),e.jsxs("label",{className:"cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(R,{className:"h-5 w-5 mr-2"}),"Add Photos/Videos",e.jsx("input",{type:"file",accept:"image/jpeg,image/png,image/gif,video/mp4",onChange:M,multiple:!0,className:"hidden"})]}),e.jsx("p",{className:"mt-2 text-sm text-gray-500 dark:text-gray-400",children:"Supported formats: JPG, PNG, GIF, MP4 (max 50MB each)"})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",disabled:x,className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:x?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"animate-spin h-4 w-4 mr-2"}),"Submitting..."]}):"Submit Report"})})]})]})};export{q as default};
